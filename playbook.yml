---
- name: 0x1337 Networking Services Concourse/Ansible Pipeline
  hosts: all
  gather_facts: false

  tasks:
  - name: Load config variables and vault secret
    include_vars:
      dir: vars
      ignore_unknown_extensions: True
      extensions: ['yml']

  - name: Attempt and graceful roll back demo
    block:
      - debug:
          msg: 'I execute normally'
      - name: i force a failure
        command: /bin/false
      - debug:
          msg: 'I never execute, due to the above task failing, :-('
    rescue:
      - debug:
          msg: 'I caught an error'
      - name: i force a failure in middle of recovery! >:-)
        command: /bin/false
      - debug:
          msg: 'I also never execute :-('
    always:
      - debug:
          msg: "This always executes"

  - name: ping
    action: ping
    register: var_ping
    ignore_errors: yes
  
  - debug:
      var: var_ping

  - name: Display variable from encrypted vault
    debug:
      var: vault_ssh_key
